# Custom Database Integration Guide

This guide explains how to integrate your own Supabase database with Celia Clips to act as a source for transcripts. This is useful for "Pro" workflows where you have a separate pipeline generating transcripts (e.g. from AssemblyAI, Deepgram, or human transcription) and want Celia to use them instead of re-transcribing locally.

## 1. Understanding the Data Model

Celia relies on two key concepts: **Episodes** and **Utterances**.

### Episodes
An **Episode** represents a single media file (video or audio).
- **ID:** Unique identifier (e.g., `EP097`).
- **Metadata:** Title, duration, date.

### Utterances
An **Utterance** is the atomic unit of a transcript. It represents a continuous segment of speech by one speaker.
- **Example:** *"Hello everyone, welcome back"* said by Speaker A from `00:00` to `00:05`.
- **Structure:**
  - `speaker`: Who is speaking (`A`, `B`, `SPEAKER_00`).
  - `text`: What was said.
  - `start_time`: When it started (seconds).
  - `end_time`: When it ended (seconds).

## 2. Database Schema

For Celia to read your data, your Supabase database must have these tables. Run this SQL in your Supabase SQL Editor:

```sql
-- 1. Episodes Table (Optional, for metadata)
create table if not exists public.episodes (
  id text primary key, -- e.g., 'EP097'
  title text,
  duration_seconds float,
  created_at timestamptz default now()
);

-- 2. Utterances Table (Required)
create table if not exists public.utterances (
  id bigint generated by default as identity primary key,
  episode_id text not null references public.episodes(id),
  speaker text,        -- 'A', 'B', 'SPEAKER_00', etc.
  text text not null,
  start_time float not null,
  end_time float not null,
  confidence float default 1.0,
  created_at timestamptz default now()
);

-- Indexes for performance
create index if not exists idx_utterances_episode_id on public.utterances(episode_id);
create index if not exists idx_utterances_start_time on public.utterances(start_time);

-- Security (RLS) - Recommended
alter table public.episodes enable row level security;
alter table public.utterances enable row level security;

-- Policy: Allow read access to anon key (if you want public access, otherwise restrict)
create policy "Allow generic read access" on public.episodes for select using (true);
create policy "Allow generic read access" on public.utterances for select using (true);
```

## 3. Uploading Transcripts

If you have transcript JSON files (e.g. from Whisper), you can use the provided utility script to upload them to your Supabase database.

### Script Location
`tools/upload_transcript.py` (Created in this guide)

### Usage
```bash
# 1. Install dependencies
pip install supabase

# 2. Set env vars (or pass in script)
export SUPABASE_URL="your-proj-url"
export SUPABASE_KEY="your-service-role-key" # Needs write access

# 3. Run script
python tools/upload_transcript.py path/to/transcript.json --episode_id "EP100"
```

## 4. Connecting to Celia Dashboard

1. Go to **Settings > Transcription**
2. Select **Source: Custom Database**
3. Enter your **Supabase URL** and **Anon Key**
4. Celia will now look for transcripts in your DB before trying to transcribe locally.
